#!/bin/bash -e
# Build package 'libffi' from source
# For Calmira 1.2a2.1 GNU/Linux-libre
# Copyright (C) 2021, 2022 Michail Krasnov <linuxoid85@gmail.com>

NAME="libffi"
VERSION="3.4.2"

cd /usr/src/$NAME-$VERSION

#################################### NOTE ######################################
# Далее приводится скрипт configure с переданным ему ключом
# '--with-gcc-arch=x86-64'. Для того, чтобы собрать 'libffi' с оптимизациями для
# текущего железа, либо для нужной вам машины, замените 'x86-64' на нужное
# значение. Если сгенерированный код будет скопирован из собственной системы в
# менее работоспособную систему, используйте менее работоспособную систему в
# качестве параметра. Для этого просмотрите поддерживаемые типы:
# https://gcc.gnu.org/onlinedocs/gcc-10.2.0/gcc/x86-Options.html
################################################################################

################################### NOTE 2 #####################################
# Здесь указывается ключ '--disable-exec-tramp', которая отключает статическую
# поддержку trampoline. Это новая функция безопасности в 'libffi', но некоторые
# пакеты в системе портов Calmira GNU/Linux (например, GJS) не были адаптированы
# для этого.
################################################################################
./configure --prefix=/usr          \
            --disable-static       \
            --with-gcc-arch=x86-64 \
            --disable-exec-static-tramp

make
make install
